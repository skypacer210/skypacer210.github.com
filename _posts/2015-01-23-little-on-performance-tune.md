---
layout: post
title: "浅谈VDI优化"
categories:
- technology
tags:
- performance tune
- TLS
- memory pool


---


### 概述 ###

VDI优化涉及到诸多系统的方面，主要包括：  

![图片](/assets/images/perf/perf_framework.jpg)


### TLS层的优化点 ###

TLS连接的建立和关闭过程如图：  

![图片](/assets/images/perf/SSL_handshake.png)

在TLS中频繁分配释放的内存主要有以下几类：   
- 哈希描述符和哈希值;  
- 密钥，比如masterkey为48字节;  
- 典型的小块内存，一般为64字节和96字节;    

Memory Pool的主要设计思路：  
- 每块内存都看做一个对象，预先分配好一定数量的对象，即所谓的内存池；  
- 定义get和put方法，一般成对出现，这样保证了预分配的对象数量可控；    
- 内存池内的每个对象用单向链表维护，具体操作见图；  

![图片](/assets/images/perf/mem_pool.jpg)


对SSL的握手过程进行对比测试，结果表明在使用mem pool的性能提升为8%左右，似乎并不理想，看来在SSL握手中此类内存的分配释放并不是影响性能的主要因素。 


### 充分利用硬件加速 ###  

对于计算密集型的加解密运算，首先想到的就是利用硬件进行加速，这里有两个方面的考虑：  

- 主存和硬件加速单元之间的IO： 数据从主存搬移至硬件，硬件将结果返回给主存  
- 对硬件处理结果的查询方式选择： 轮询还是中断？    

针对上述考虑，采取的措施如下：    

- 分析分析硬件加速的实现代码，发现其涉及到非常多固定大小内存的分配与释放，依然采用上文中的cache机制，需要注意的是硬件读写时要求地址对齐，因此对cache实现稍作修改，加入内存对齐处理。测试结果显示，后者能将性能提升50%左右。  
- 利用DMA进行数据拷贝避免动用CPU在主存和硬件加速单元之前拷贝，测试结果表明两者的性能差异大约在2倍左右。
- 分别实现中断模式和轮询模式，对比后发现轮询模式下效率更高，因此选择了轮询模式。  

整体而言，采用硬件加速就是在充分利用压榨硬件计算性能的基础上尽可能减少内存拷贝和IO消耗，最后性能平均提升大约十倍左右。  

